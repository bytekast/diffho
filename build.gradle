plugins {
  id 'application'
  id 'idea'
  id 'scala'
  id 'com.palantir.graal' version '0.3.0-23-g26fa21c'
  id 'com.github.johnrengelman.shadow' version '5.0.0'
}

repositories {
  mavenCentral()
  jcenter()
}

configurations {
  generateConfig
}

dependencies {
  compile(
    'org.scala-lang:scala-library:2.12.6',
    'com.typesafe:config:1.3.3',
    'org.fusesource.jansi:jansi:1.18'
  )
}

application {
  mainClassName = 'com.bytekast.Diffho'
}

task('generateGraalReflectionConfig', dependsOn: 'classes', type: JavaExec) {
  main = 'picocli.codegen.aot.graalvm.ReflectionConfigGenerator'
  classpath = configurations.generateConfig + sourceSets.main.runtimeClasspath
  def outputFile = new File(project.buildDir, 'cli-reflect.json')
  args = ["--output=$outputFile", 'com.bytekast.Diffho']
}

graal {
  mainClass 'com.bytekast.Diffho'
  outputName 'diffho'
  graalVersion '1.0.0-rc15'
  option '-H:+ReportUnsupportedElementsAtRuntime'
  option '-H:+ReportExceptionStackTraces'
  option '--no-fallback'
}

build.dependsOn shadowJar